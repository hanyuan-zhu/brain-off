# 工程造价 Agent - 开发计划

## 📊 当前状态总结

### ✅ 已完成（Phase 1 - CAD 解析）
- **CAD 文件加载**: `load_cad_file()` - 完全实现
- **实体提取**: `extract_cad_entities()` - 完全实现
- **工程量计算**: `calculate_cad_measurements()` - 完全实现
- **测试验证**: 使用真实建筑图纸测试通过

**测试结果**:
- ✅ 成功加载 17MB DXF 文件
- ✅ 识别 44 个图层，8620 个实体
- ✅ 提取墙体长度 847.43m
- ✅ 统计柱子 17 个，窗户 6 个

---

## 🎯 核心问题分析

### 当前工具能做什么
1. **几何信息提取** (80% 完成度)
   - ✅ 墙体长度统计
   - ✅ 柱子数量统计
   - ✅ 门窗数量统计
   - ✅ 图层识别和分类

2. **基础工程量** (30% 完成度)
   - ✅ 长度计算
   - ✅ 数量统计
   - ❌ 体积计算（缺少高度）
   - ❌ 面积计算（缺少厚度）

### 关键缺失信息
1. **构件尺寸参数** (10% 完成度)
   - ❌ 墙体厚度（120/200/240mm?）
   - ❌ 墙体高度（层高?）
   - ❌ 柱子截面尺寸
   - ❌ 门窗尺寸

2. **材料信息** (0% 完成度)
   - ❌ 墙体材料类型
   - ❌ 混凝土标号
   - ❌ 砌块类型

3. **文字标注** (部分缺失)
   - ✅ 提取到 1196 个文字
   - ❌ 文字碎片化（单字分离）
   - ❌ 无法关联文字与构件

---

## 🚀 开发路线图

### Phase 2: 视觉 AI 分析（核心优先级）

**目标**: 通过视觉 AI 补充缺失的尺寸和材料信息

#### 2.1 CAD 转图片
**文件**: `services/vision_service.py`

**功能**: `convert_cad_to_image()`
- 输入: DXF 文件路径、图层选择、输出格式
- 输出: 图片文件路径列表
- 技术方案:
  - 方案 A: matplotlib + ezdxf（推荐，纯 Python）
  - 方案 B: AutoCAD API（需要 AutoCAD）
  - 方案 C: 在线转换服务

**实现要点**:
```python
def convert_cad_to_image(
    cad_file_path: str,
    output_dir: str,
    layers: List[str] = None,
    format: str = "png",
    dpi: int = 300
) -> Dict[str, Any]:
    """
    将 CAD 转换为高清图片

    返回:
    {
        "success": True,
        "images": [
            {"path": "xxx.png", "layers": [...], "bbox": {...}}
        ]
    }
    """
```

**预期输出**:
- 全图视图（用于整体理解）
- 分图层视图（墙体、标注、文字等）
- 局部放大视图（细节标注）

**优先级**: 🔴 高（必须完成）

---

#### 2.2 视觉 AI 分析
**文件**: `services/vision_service.py`

**功能**: `analyze_drawing_visual()`
- 输入: 图片路径、分析任务
- 输出: AI 识别结果
- 技术: Kimi 2.5 / GPT-4V

**分析任务类型**:
1. **整体理解**: 识别图纸类型、楼层、专业
2. **标注提取**: 读取尺寸标注、材料说明
3. **构件识别**: 识别墙体、柱子、门窗位置
4. **参数提取**: 提取厚度、高度、材料等参数

**实现要点**:
```python
def analyze_drawing_visual(
    image_path: str,
    analysis_type: str,  # "overview" | "annotations" | "elements"
    focus_area: Dict = None  # 可选的关注区域
) -> Dict[str, Any]:
    """
    使用多模态 AI 分析图纸

    返回:
    {
        "success": True,
        "analysis": {
            "text_annotations": [...],  # 识别的文字
            "dimensions": [...],        # 尺寸标注
            "materials": [...],         # 材料信息
            "elements": [...]           # 构件信息
        }
    }
    """
```

**优先级**: 🔴 高（必须完成）

---

#### 2.3 标注智能解析
**文件**: `services/vision_service.py`

**功能**: `extract_drawing_annotations()`
- 输入: 图片路径或 AI 分析结果
- 输出: 结构化的标注数据

**解析内容**:
- 尺寸标注: "墙厚 200" → {type: "wall_thickness", value: 200, unit: "mm"}
- 材料说明: "C30 混凝土" → {type: "material", element: "concrete", grade: "C30"}
- 层高标注: "层高 3.6m" → {type: "floor_height", value: 3.6, unit: "m"}

**优先级**: 🟡 中（重要但可后续优化）

---

### Phase 3: 数据融合与工程量计算

**目标**: 结合 CAD 几何数据和视觉 AI 分析结果，计算完整工程量

#### 3.1 数据融合引擎
**新增功能**: `merge_cad_and_visual_data()`

**输入**:
- CAD 几何数据（墙体长度、柱子数量等）
- 视觉 AI 分析结果（厚度、高度、材料等）

**输出**:
- 完整的构件信息（几何 + 参数）

**示例**:
```python
# CAD 数据
wall_length = 847.43  # m

# 视觉 AI 识别
wall_thickness = 200  # mm
wall_height = 3600    # mm
wall_material = "加气混凝土砌块"

# 融合计算
wall_volume = wall_length * 0.2 * 3.6  # m³
```

**优先级**: 🔴 高

---

#### 3.2 完整工程量计算
**增强功能**: `calculate_cad_measurements()`

**新增计算类型**:
- ✅ length（已实现）
- ✅ count（已实现）
- 🆕 area（需要厚度参数）
- 🆕 volume（需要厚度和高度参数）
- 🆕 weight（需要材料密度）

**优先级**: 🔴 高

---


### Phase 4: 定额匹配与清单生成

**目标**: 将工程量匹配到定额标准，生成规范的工程量清单

#### 4.1 定额数据库建设
**文件**: `services/quota_service.py`

**当前状态**: 框架已实现，需要数据填充

**任务**:
1. 准备定额数据源
   - 国家建筑工程定额
   - 地方定额（如北京、上海）
   - 常用清单项目库

2. 数据导入
   - 定额编码、名称、工作内容
   - 计量单位、计算规则
   - 向量化（用于语义搜索）

**优先级**: 🟡 中（可使用在线搜索替代）

---

#### 4.2 智能定额匹配
**增强功能**: `search_quota_standard()`

**匹配策略**:
1. 基于构件类型自动匹配
   - 墙体 → 砌筑工程定额
   - 柱子 → 混凝土工程定额
   - 门窗 → 门窗工程定额

2. 基于材料信息精确匹配
   - "加气混凝土砌块" → 对应定额子目

3. 用户确认机制
   - 不确定时提供多个选项
   - 记录用户选择，增量学习

**优先级**: 🟡 中

---

#### 4.3 清单生成
**文件**: `services/boq_service.py`

**当前状态**: CRUD 功能已实现

**增强任务**:
1. 自动生成清单项
   - 从工程量计算结果自动创建
   - 关联定额编码
   - 记录数据来源（溯源）

2. 清单结构化
   - 分部分项（土建、装饰、安装等）
   - 子清单管理
   - 汇总计算

**优先级**: 🟡 中

---

### Phase 5: 系统集成与优化

#### 5.1 完整工作流测试
**测试场景**:
1. 加载 CAD 文件
2. 转换为图片
3. AI 视觉分析
4. 数据融合
5. 工程量计算
6. 定额匹配
7. 生成清单
8. 导出 Excel

**优先级**: 🟢 低（集成测试）

---

#### 5.2 性能优化
**优化点**:
1. 视觉分析结果缓存（已设计 VisualAnalysis 表）
2. 大文件分块处理
3. 并行处理多个图层
4. 数据库查询优化

**优先级**: 🟢 低

---

#### 5.3 用户交互增强
**功能**:
1. 参数补充界面
   - 当 AI 无法识别时，询问用户
   - "墙体厚度是多少？"
   - "混凝土标号？"

2. 结果审核界面
   - 显示识别结果
   - 允许用户修正
   - 记录修正历史

**优先级**: 🟢 低

---

## 📋 待实现功能清单

### 🔴 高优先级（必须完成）

1. **CAD 转图片** ✅ 下一步
   - [ ] 实现 `convert_cad_to_image()`
   - [ ] 支持全图和分图层渲染
   - [ ] 生成高清 PNG（300 DPI）

2. **视觉 AI 分析** ✅ 下一步
   - [ ] 实现 `analyze_drawing_visual()`
   - [ ] 集成 Kimi 2.5 API
   - [ ] 提取标注文字和尺寸

3. **数据融合**
   - [ ] 实现 `merge_cad_and_visual_data()`
   - [ ] 关联几何数据与参数
   - [ ] 验证数据一致性

4. **完整工程量计算**
   - [ ] 增加体积计算（需要高度）
   - [ ] 增加面积计算（需要厚度）
   - [ ] 支持复杂构件（楼板、梁等）

---

### 🟡 中优先级（重要功能）

5. **定额数据库**
   - [ ] 准备定额数据源
   - [ ] 导入常用定额
   - [ ] 实现向量搜索

6. **智能定额匹配**
   - [ ] 基于构件类型匹配
   - [ ] 基于材料信息匹配
   - [ ] 用户确认机制

7. **清单自动生成**
   - [ ] 从工程量自动创建清单项
   - [ ] 清单结构化（分部分项）
   - [ ] 溯源追踪

---

### 🟢 低优先级（优化增强）

8. **性能优化**
   - [ ] 视觉分析缓存
   - [ ] 大文件分块处理
   - [ ] 并行处理

9. **用户交互**
   - [ ] 参数补充界面
   - [ ] 结果审核界面
   - [ ] 修正历史记录

10. **测试完善**
    - [ ] 单元测试
    - [ ] 集成测试
    - [ ] 端到端测试

---

## 🎯 近期开发重点

### 本周目标：实现 Phase 2（视觉 AI 分析）

**任务 1: CAD 转图片**
- 时间估算: 需要实现和测试
- 技术选型: matplotlib + ezdxf
- 输出: 高清 PNG 图片

**任务 2: 视觉 AI 分析**
- 时间估算: 需要实现和测试
- API 集成: Kimi 2.5
- 输出: 结构化标注数据

**任务 3: 端到端测试**
- 使用真实图纸测试
- 验证识别准确率
- 优化 prompt

---

## 💡 技术决策

### CAD 转图片方案选择

**方案对比**:

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| matplotlib + ezdxf | 纯 Python，跨平台 | 渲染质量一般 | ⭐⭐⭐⭐ |
| AutoCAD API | 渲染质量最好 | 需要 AutoCAD | ⭐⭐ |
| 在线转换 | 无需本地处理 | 依赖网络，隐私问题 | ⭐⭐⭐ |

**决策**: 优先使用 matplotlib + ezdxf，后续可增加其他方案作为备选

---

### 视觉 AI 模型选择

**模型对比**:

| 模型 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| Kimi 2.5 | 中文好，价格低 | API 限制 | ⭐⭐⭐⭐⭐ |
| GPT-4V | 能力强，稳定 | 价格高 | ⭐⭐⭐⭐ |
| Claude 3.5 | 视觉能力强 | 价格较高 | ⭐⭐⭐⭐ |

**决策**: 默认使用 Kimi 2.5，支持切换到其他模型

---

## 📝 开发注意事项

1. **保持向后兼容**: 新功能不影响已实现的 CAD 解析
2. **错误处理**: 每个函数都要有完善的错误处理
3. **日志记录**: 记录关键步骤，便于调试
4. **测试驱动**: 先写测试，再实现功能
5. **文档同步**: 及时更新 README 和 ARCHITECTURE

---

## 🎉 总结

**当前进度**: Phase 1 完成（CAD 解析）✅

**下一步**: Phase 2（视觉 AI 分析）🚀

**核心目标**: 通过视觉 AI 补充缺失的尺寸和材料信息，实现完整的工程量清单生成

**预期效果**: 
- 输入: CAD 图纸
- 输出: 完整的工程量清单（Excel）
- 准确率: 80%+ （人工审核后可达 95%+）

